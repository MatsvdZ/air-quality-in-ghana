<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title><%= title %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <link rel="stylesheet" href="/css/main.css" />
  </head>

  <body>
    <%- include('partials/topnav') %>
    <main class="app-main"><%- body %></main>

    <%- include('partials/bottomnav') %>

    <script>
      (function () {
        const nav = document.querySelector(".bottom-nav");
        if (!nav) return;

        const indicator = nav.querySelector(".bottom-nav__indicator");
        const items = Array.from(nav.querySelectorAll(".bottom-nav__item"));
        if (!indicator || !items.length) return;

        function bestMatchItem() {
          const p = window.location.pathname;

          // Exact match first (/, /map, /download, /admin)
          let item =
            items.find((a) => a.getAttribute("href") === p) ||
            // Then prefix match (/map/..., /download/..., /admin/...)
            items.find((a) => p.startsWith(a.getAttribute("href") + "/"));

          // Fallbacks
          if (!item) {
            if (p.startsWith("/admin"))
              item = items.find((a) => a.getAttribute("href") === "/admin");
            else if (p.startsWith("/map"))
              item = items.find((a) => a.getAttribute("href") === "/map");
            else if (p.startsWith("/download"))
              item = items.find((a) => a.getAttribute("href") === "/download");
            else
              item =
                items.find((a) => a.getAttribute("href") === "/") || items[0];
          }

          return item || items[0];
        }

        function setActive(el) {
          items.forEach((x) => x.classList.remove("is-active"));
          el.classList.add("is-active");
        }

        function moveIndicatorTo(el) {
          const navRect = nav.getBoundingClientRect();
          const r = el.getBoundingClientRect();
          const left = r.left - navRect.left;

          indicator.style.width = r.width + "px";
          indicator.style.transform = `translateX(${left}px)`;
        }

        // Initial setup
        const initial = bestMatchItem();
        setActive(initial);
        moveIndicatorTo(initial);

        window.addEventListener("resize", () => {
          const current = bestMatchItem();
          setActive(current);
          moveIndicatorTo(current);
        });

        // On click, delay navigation for indicator animation
        items.forEach((a) => {
          a.addEventListener("click", (e) => {
            const href = a.getAttribute("href");
            if (!href) return;

            // If already on the same section, don't delay
            const p = window.location.pathname;
            const sameSection =
              (href === "/" && p === "/") ||
              (href !== "/" && (p === href || p.startsWith(href + "/")));

            if (sameSection) return;

            e.preventDefault();
            setActive(a);
            moveIndicatorTo(a);

            setTimeout(() => {
              window.location.href = href;
            }, 180);
          });
        });
      })();
    </script>
  </body>
</html>
