<section class="page">
  <div class="page__header">
    <h1 class="page__title"><%= title %></h1>
    <p class="page__subtitle">Check the nitrogen dioxide (NO₂) level.</p>
  </div>

  <div class="grid">
    <!-- Ranking -->
    <article class="card">
      <h2 class="card__title">Ranking</h2>
      <p class="card__meta">
        Time series per tube, location and measurement period.
      </p>

      <ol id="rankingList" class="ranking-list">
        <li class="ranking-loading">Loading ranking…</li>
      </ol>

      <p class="ranking-note">Lowest NO₂ (latest month).</p>
    </article>

    <!-- Mini map (zonder card eromheen) -->
    <a href="/map" class="home-map-preview" aria-label="Open map">
      <div class="home-map-preview__inner"></div>
    </a>

    <!-- What is NO2 -->
    <article class="card">
      <h2 class="card__title">What is nitrogen dioxide (NO₂)?</h2>
      <p class="card__meta">
        Nitrogen dioxide (NO₂) is a major contributor to the formation of smog
        and a precursor to many harmful secondary pollutants, including ozone
        and particulate matter (PM). It's highly reactive with other chemicals
        and is a strong oxidizing agent.
      </p>
    </article>

    <div class="hint">
      <p class="hint__text">
        Source:
        <a href="https://www.iqair.com/newsroom/nitrogen-dioxide">
          https://www.iqair.com/newsroom/nitrogen-dioxide
        </a>
      </p>
    </div>

    <!-- About us -->
    <article class="card">
      <h2 class="card__title">About us</h2>

      <details class="accordion" open>
        <summary class="accordion__summary">About this platform</summary>
        <div class="accordion__content">
          <p class="card__meta">
            This webportal shows air quality data collected in Ghana with the
            aim of making nitrogen dioxide data more visible and understandable
            for citizens and researchers. Our webportal shows measurements
            collected with low-cost sensors (air quality tubes) at various
            locations in Ghana. We aim to provide insights into air pollution
            levels, trends, and potential health impacts.
          </p>
        </div>
      </details>

      <details class="accordion">
        <summary class="accordion__summary">Measuring air quality</summary>
        <div class="accordion__content">
          <p class="card__meta">
            The air quality tubes used in this project are passive diffusion
            tubes that absorb nitrogen dioxide (NO₂) from the air over a monthly
            period. After exposure, the tubes are sent to a laboratory for
            analysis to determine the average NO₂ concentration during the
            exposure period. This method provides a cost-effective way to
            monitor air quality across multiple locations.
          </p>
        </div>
      </details>

      <details class="accordion">
        <summary class="accordion__summary">
          Collaboration and contributions
        </summary>
        <div class="accordion__content">
          <p class="card__meta">
            This project is a collaboration between the KNMI (Royal Netherlands
            Meteorological Institute) and the KNUST (Kwame Nkrumah University of
            Science and Technology) in Ghana. The KNUST team is responsible for
            deploying the air quality tubes and collecting the data, while the
            KNMI and their partners handle the data processing, analysis, and
            webportal development.
          </p>
        </div>
      </details>
    </article>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const el = document.querySelector(".home-map-preview__inner");
    if (!el) return;

    // Mini Leaflet preview
    const miniMap = L.map(el, {
      zoomControl: false,
      attributionControl: false,
      dragging: true,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      tap: false,
      touchZoom: false,
    }).setView([6.6796, -1.6063], 12);

    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
      { subdomains: "abcd", maxZoom: 16 }
    ).addTo(miniMap);

    try {
      const res = await fetch("/api/locations");
      const allLocations = await res.json();

      // 1) verzamel alle periods en pak de nieuwste
      const periodSet = new Set();
      allLocations.forEach((loc) => {
        (loc.history || []).forEach((h) => {
          if (h.dateStr) periodSet.add(h.dateStr);
        });
      });

      const periods = Array.from(periodSet);
      if (!periods.length) return;

      // dateStr is bij jou "MMM YYYY" (bijv. "Oct 2025")
      // We sorteren op echte datum
      const toDate = (p) => {
        const d = new Date(p); // werkt voor "Oct 2025"
        return isNaN(d) ? new Date(0) : d;
      };

      periods.sort((a, b) => toDate(a) - toDate(b));
      const latestPeriod = periods[periods.length - 1];

      // 2) teken cirkels voor de nieuwste periode
      allLocations.forEach((loc) => {
        const lat = Number(loc.lat);
        const lon = Number(loc.lon);
        if (!lat || !lon) return;

        const m = (loc.history || []).find((h) => h.dateStr === latestPeriod);
        const v = m?.val;

        // geen data? teken klein grijs puntje of skip
        if (
          v === undefined ||
          v === null ||
          v === "" ||
          Number.isNaN(Number(v))
        ) {
          // Wil je no-data helemaal niet tonen? return;
          const dot = L.circleMarker([lat, lon], {
            color: "rgba(255,255,255,.9)",
            weight: 1,
            fillColor: "#bdc3c7",
            fillOpacity: 0.55,
            radius: 4,
          }).addTo(miniMap);
          return;
        }

        const value = Number(v);
        const color = getColor(value);

        L.circleMarker([lat, lon], {
          color: "rgba(255,255,255,.95)",
          weight: 1,
          fillColor: color,
          fillOpacity: 0.85,
          radius: 6,
        }).addTo(miniMap);
      });
    } catch (e) {
      console.error("Mini map preview failed:", e);
    }
  });

  // Zelfde kleuren als je map.js
  function getColor(value) {
    if (value > 80) return "#7E0023";
    if (value > 70) return "#8F3F97";
    if (value > 60) return "#C92033";
    if (value > 50) return "#DA5634";
    if (value > 40) return "#EA8C34";
    if (value > 30) return "#ECAA33";
    if (value > 20) return "#EEC732";
    if (value > 10) return "#A3BF29";
    return "#59B61F";
  }

  async function loadRanking() {
    const list = document.getElementById("rankingList");
    if (!list) return;

    try {
      const res = await fetch("/api/ranking");
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        list.innerHTML = `<li class="ranking-loading">No ranking data available.</li>`;
        return;
      }

      list.innerHTML = data
        .slice(0, 3)
        .map(
          (r, i) => `
        <li class="ranking-item">
          <span class="rank-badge">${i + 1}</span>
          <div class="rank-info">
            <strong class="rank-name">${r.name || r.locationId}</strong>
            <span class="rank-sub">${r.locationId} • ${r.period}</span>
          </div>
          <span class="rank-value">${Number(r.avgNo2).toFixed(1)} µg/m³</span>
        </li>
      `
        )
        .join("");
    } catch (e) {
      console.error(e);
      list.innerHTML = `<li class="ranking-loading">Error loading ranking.</li>`;
    }
  }

  loadRanking();

  document.querySelectorAll(".accordion").forEach((details) => {
    const summary = details.querySelector(".accordion__summary");
    const content = details.querySelector(".accordion__content");

    // Helper: zet hoogte correct als hij open start
    if (details.open) {
      content.style.maxHeight = content.scrollHeight + "px";
    }

    summary.addEventListener("click", (e) => {
      e.preventDefault();

      const isOpen = details.open;

      if (isOpen) {
        // --- CLOSE (smooth) ---
        // 1) Zet eerst current hoogte (van auto naar px)
        content.style.maxHeight = content.scrollHeight + "px";

        // 2) Force reflow zodat de browser dit "pakt"
        content.offsetHeight;

        // 3) Animeer naar 0
        content.style.maxHeight = "0px";

        // 4) Pas NA de animatie details sluiten (anders springt het)
        const onEnd = () => {
          details.open = false;
          content.removeEventListener("transitionend", onEnd);
        };
        content.addEventListener("transitionend", onEnd);
      } else {
        // --- OPEN (smooth) ---
        // 1) Open details eerst zodat content meetbaar is
        details.open = true;

        // 2) Zet max-height naar 0 (startpunt)
        content.style.maxHeight = "0px";

        // 3) Force reflow
        content.offsetHeight;

        // 4) Animeer naar scrollHeight
        content.style.maxHeight = content.scrollHeight + "px";
      }
    });

    // Als content verandert (responsive), pas hoogte aan
    window.addEventListener("resize", () => {
      if (details.open) {
        content.style.maxHeight = content.scrollHeight + "px";
      }
    });
  });
</script>
